# KnC_Bewertung MATLAB to Python 重构计划

## 1. 重构目标

### 1.1 总体目标
将MATLAB App完整重构为Python应用程序，实现：
- **1:1功能复刻**: 保留所有现有功能
- **图表一致性**: 绘制的Plot与MATLAB版本完全一致
- **功能保留**: 未实现的功能按钮需保留，供后期添加
- **代码质量**: 提高代码可维护性和可扩展性

### 1.2 技术选型
- **GUI框架**: PyQt6（推荐，更现代的UI框架，支持更好的样式和主题，UI更精美）
- **数据处理**: NumPy, Pandas
- **绘图**: Matplotlib（确保与MATLAB图表一致）
- **文件处理**: 标准库 + 正则表达式
- **配置管理**: YAML或JSON

## 2. 项目结构设计

### 2.1 目录结构
```
Python_Target/
├── src/
│   ├── main.py                    # 主程序入口
│   ├── gui/                       # GUI模块
│   │   ├── __init__.py
│   │   ├── main_window.py        # 主窗口
│   │   ├── vehicle_params.py     # 车辆参数面板
│   │   ├── kc_tabs.py            # K&C分析Tab
│   │   ├── plot_widgets.py       # 图表组件
│   │   └── widgets/               # 自定义控件
│   ├── data/                      # 数据处理模块
│   │   ├── __init__.py
│   │   ├── res_parser.py         # .res文件解析
│   │   ├── kc_calculator.py      # K&C计算
│   │   ├── data_extractor.py     # 数据提取
│   │   └── unit_converter.py     # 单位转换
│   ├── plot/                      # 绘图模块
│   │   ├── __init__.py
│   │   ├── bump_plot.py          # Bump测试绘图
│   │   ├── roll_plot.py          # Roll测试绘图
│   │   ├── static_load_plot.py   # 静态载荷测试绘图
│   │   └── plot_utils.py         # 绘图工具函数
│   ├── config/                    # 配置模块
│   │   ├── __init__.py
│   │   ├── kc_params.py          # K&C参数ID映射
│   │   ├── ui_config.py          # UI配置
│   │   └── plot_config.py        # 绘图配置
│   └── utils/                     # 工具模块
│       ├── __init__.py
│       ├── file_utils.py          # 文件工具
│       ├── math_utils.py         # 数学工具
│       └── validators.py         # 数据验证
├── resources/                     # 资源文件
│   ├── images/                    # 图像文件
│   └── icons/                     # 图标文件
├── config/                        # 配置文件
│   ├── kc_params.yaml            # K&C参数配置
│   └── app_config.yaml           # 应用配置
├── tests/                         # 测试文件
│   ├── test_res_parser.py
│   ├── test_kc_calculator.py
│   └── test_data/
├── docs/                          # 文档
│   ├── api/                       # API文档
│   └── user_guide/                # 用户指南
├── requirements.txt               # Python依赖
└── README.md                     # 项目说明
```

## 3. 分模块重构计划

### 3.1 阶段一：基础架构搭建（Week 1-2）

#### 3.1.1 项目初始化
- [ ] 创建项目目录结构
- [ ] 设置Python虚拟环境
- [ ] 编写requirements.txt
- [ ] 配置开发环境
- [ ] 初始化Git仓库

#### 3.1.2 核心工具模块
- [ ] **file_utils.py**: 文件读取、行数统计（替代countlines.pl）
- [ ] **math_utils.py**: 线性拟合（numpy.polyfit）、数学计算
- [ ] **validators.py**: 数据验证、错误检查
- [ ] **unit_converter.py**: 单位转换函数

#### 3.1.3 配置文件
- [ ] **kc_params.yaml**: K&C参数ID映射配置
- [ ] **app_config.yaml**: 应用默认配置
- [ ] 配置加载模块

### 3.2 阶段二：数据解析模块（Week 3-4）

#### 3.2.1 .res文件解析器
- [ ] **res_parser.py**:
  - [ ] 文件行数统计（Windows/Linux兼容）
  - [ ] 逐行读取和解析
  - [ ] 参数ID提取（正则表达式匹配）
  - [ ] quasiStatic数据段提取
  - [ ] 数据矩阵构建

#### 3.2.2 数据提取模块
- [ ] **data_extractor.py**:
  - [ ] 根据ID提取数据列
  - [ ] 数据筛选和过滤
  - [ ] 数据预处理

#### 3.2.3 单位转换模块
- [ ] **unit_converter.py**:
  - [ ] 角度转换（弧度↔度）
  - [ ] 长度转换（mm↔m）
  - [ ] 刚度转换
  - [ ] 批量转换函数

### 3.3 阶段三：K&C计算模块（Week 5-6）

#### 3.3.1 基础计算
- [ ] **kc_calculator.py**:
  - [ ] 线性拟合计算
  - [ ] 特征点定位（0位置、满载位置等）
  - [ ] 斜率计算
  - [ ] 指标计算

#### 3.3.2 各工况计算函数
- [ ] **Bump计算**:
  - [ ] Bump Steer计算
  - [ ] Bump Camber计算
  - [ ] Wheel Rate计算
  - [ ] Wheel Recession计算
  - [ ] Track Change计算
  - [ ] Castor Angle计算
  - [ ] SVSA计算
  - [ ] 50mm轮跳toe角
  - [ ] 2g载荷相关计算

- [ ] **Roll计算**:
  - [ ] Roll Steer计算
  - [ ] Roll Camber计算
  - [ ] Roll Camber Relative Ground计算
  - [ ] Roll Steer @ WT计算
  - [ ] Roll Camber @ WT计算
  - [ ] Roll Rate计算
  - [ ] Roll Center Height计算

- [ ] **Static Load Lateral计算**:
  - [ ] Lateral Toe Compliance计算
  - [ ] Lateral Camber Compliance计算
  - [ ] Lateral Compliance计算
  - [ ] Lateral PC Compliance计算

- [ ] **Static Load Braking计算**:
  - [ ] Braking Toe Compliance计算
  - [ ] Braking Camber Compliance计算
  - [ ] Braking WC Compliance计算
  - [ ] Braking PC Compliance计算
  - [ ] Anti-dive计算

- [ ] **Static Load Acceleration计算**:
  - [ ] Acceleration Toe Compliance计算
  - [ ] Acceleration Camber Compliance计算
  - [ ] Acceleration WC Compliance计算
  - [ ] Anti-squat计算

### 3.4 阶段四：绘图模块（Week 7-9）

#### 3.4.1 绘图工具函数
- [ ] **plot_utils.py**:
  - [ ] 图表样式配置（字体、颜色、网格等）
  - [ ] 坐标轴设置
  - [ ] 图例设置
  - [ ] 文本标注函数
  - [ ] 方向指示函数

#### 3.4.2 Bump测试绘图
- [ ] **bump_plot.py**:
  - [ ] Bump Steer图（左右对比）
  - [ ] Bump Camber图（左右对比）
  - [ ] Wheel Rate图（左右对比）
  - [ ] Wheel Recession图（左右对比）
  - [ ] Track Change图（左右对比）
  - [ ] Castor Angle图（左右对比）
  - [ ] SVSA Angle图（左右对比）
  - [ ] SVSA Length图（左右对比）
  - [ ] Wheel Load图（左右对比）

#### 3.4.3 Roll测试绘图
- [ ] **roll_plot.py**:
  - [ ] Roll Steer图（左右对比）
  - [ ] Roll Camber图（左右对比）
  - [ ] Roll Camber Relative Ground图（左右对比）
  - [ ] Roll Steer @ WT图（左右对比）
  - [ ] Roll Camber @ WT图（左右对比）
  - [ ] Suspension Roll Rate图
  - [ ] Total Roll Rate图
  - [ ] Roll Center Height图
  - [ ] Tire Force图

#### 3.4.4 静态载荷测试绘图
- [ ] **static_load_plot.py**:
  - [ ] Lateral Toe Compliance图（左右对比）
  - [ ] Lateral Camber Compliance图（左右对比）
  - [ ] Lateral Compliance图（左右对比）
  - [ ] Lateral PC Compliance图（左右对比）
  - [ ] Braking Toe Compliance图（左右对比）
  - [ ] Braking Camber Compliance图（左右对比）
  - [ ] Braking WC Compliance图（左右对比）
  - [ ] Braking PC Compliance图（左右对比）
  - [ ] Anti-dive图（左右对比）
  - [ ] Acceleration相关图

#### 3.4.5 图表一致性保证
- [ ] 对比MATLAB和Python图表
- [ ] 调整matplotlib参数以匹配MATLAB样式
- [ ] 确保字体、颜色、线型一致
- [ ] 确保坐标轴刻度一致
- [ ] 确保文本位置一致

### 3.5 阶段五：GUI界面（Week 10-12）

#### 3.5.1 主窗口
- [ ] **main_window.py**:
  - [ ] 窗口布局
  - [ ] 菜单栏
  - [ ] 状态栏
  - [ ] 工具栏
  - [ ] Tab组管理

#### 3.5.2 车辆参数面板
- [ ] **vehicle_params.py**:
  - [ ] 参数输入控件
  - [ ] 参数验证
  - [ ] 参数保存/加载
  - [ ] 参数单位显示

#### 3.5.3 K&C分析Tab
- [ ] **kc_tabs.py**:
  - [ ] START/INFO Tab
  - [ ] Bump Tab
  - [ ] Roll Test Tab
  - [ ] Static Load Lateral Tab
  - [ ] Static Load Braking Tab
  - [ ] Static Load Acceleration Tab
  - [ ] Align Torque Tab（保留，未实现）

#### 3.5.4 每个Tab包含
- [ ] 文件选择组件
- [ ] 结果面板
- [ ] 图表Tab组
- [ ] 控制按钮
- [ ] 参考车辆选择（保留，未实现）

#### 3.5.5 图表组件
- [ ] **plot_widgets.py**:
  - [ ] 自定义Matplotlib Widget
  - [ ] 图表管理
  - [ ] 图表更新
  - [ ] 图表清空
  - [ ] 图表导出

#### 3.5.6 全局控制
- [ ] 颜色选择器
- [ ] 对比数量Spinner
- [ ] 保存按钮（保留，未实现）
- [ ] Reset按钮
- [ ] 其他功能按钮（保留，未实现）

### 3.6 阶段六：功能集成（Week 13-14）

#### 3.6.1 主程序集成
- [ ] **main.py**:
  - [ ] 应用初始化
  - [ ] 模块导入
  - [ ] 事件循环
  - [ ] 异常处理

#### 3.6.2 功能连接
- [ ] 文件选择 → 数据解析 → 计算 → 绘图
- [ ] 参数输入 → 计算更新
- [ ] 按钮事件绑定
- [ ] 数据流管理

#### 3.6.3 错误处理
- [ ] 文件读取错误
- [ ] 数据解析错误
- [ ] 计算错误
- [ ] 绘图错误
- [ ] 用户输入验证

### 3.7 阶段七：测试与优化（Week 15-16）

#### 3.7.1 单元测试
- [ ] 数据解析测试
- [ ] 计算函数测试
- [ ] 单位转换测试
- [ ] 绘图函数测试

#### 3.7.2 集成测试
- [ ] 完整流程测试
- [ ] 各工况测试
- [ ] UI交互测试

#### 3.7.3 性能优化
- [ ] 大文件读取优化
- [ ] 数据处理优化
- [ ] 绘图性能优化
- [ ] 内存管理

#### 3.7.4 图表一致性验证
- [ ] 与MATLAB版本对比
- [ ] 逐个图表验证
- [ ] 样式调整
- [ ] 最终确认

### 3.8 阶段八：文档与发布（Week 17-18）

#### 3.8.1 代码文档
- [ ] API文档
- [ ] 函数注释
- [ ] 类文档
- [ ] 模块说明

#### 3.8.2 用户文档
- [ ] 用户指南
- [ ] 安装说明
- [ ] 使用教程
- [ ] 常见问题

#### 3.8.3 开发文档
- [ ] 架构说明
- [ ] 开发指南
- [ ] 扩展指南
- [ ] 贡献指南

## 4. 详细实施步骤

### 4.1 第一步：环境准备
1. 安装Python 3.8+
2. 创建虚拟环境
3. 安装依赖包：
   ```
   numpy
   pandas
   matplotlib
   PyQt5
   pyyaml
   pytest
   ```
4. 设置开发环境（IDE、代码格式化工具等）

### 4.2 第二步：配置文件设计
1. **kc_params.yaml**: 定义所有K&C参数ID映射
2. **app_config.yaml**: 定义应用默认配置
3. 设计配置加载机制

### 4.3 第三步：核心模块开发顺序
1. **文件工具** → 2. **数据解析** → 3. **单位转换** → 4. **计算函数** → 5. **绘图函数** → 6. **GUI界面**

### 4.4 第四步：模块测试
每个模块开发完成后立即进行单元测试

### 4.5 第五步：集成测试
所有模块完成后进行集成测试

### 4.6 第六步：图表一致性验证
逐个对比MATLAB和Python图表，确保完全一致

## 5. 关键技术点

### 5.1 .res文件解析
- 使用正则表达式匹配参数ID
- 逐行读取大文件（避免内存溢出）
- 识别quasiStatic数据段
- 处理不同操作系统（Windows/Linux）

### 5.2 数据计算
- 使用numpy.polyfit进行线性拟合
- 特征点定位算法
- 单位转换精度保证

### 5.3 绘图一致性
- Matplotlib样式配置
- 字体设置（Times New Roman）
- 颜色匹配
- 坐标轴格式
- 文本位置精确控制

### 5.4 GUI设计
- PyQt5布局管理
- 自定义Widget
- 事件处理
- 数据绑定

## 6. 风险与应对

### 6.1 风险识别
1. **图表一致性难以保证**: MATLAB和Matplotlib默认样式不同
2. **大文件处理性能**: .res文件可能很大
3. **复杂UI实现**: PyQt5学习曲线
4. **未实现功能**: 需要保留但不确定实现方式

### 6.2 应对措施
1. **图表一致性**:
   - 详细对比MATLAB图表样式
   - 创建样式配置文件
   - 逐个验证每个图表
   - 必要时使用matplotlib的MATLAB兼容模式

2. **性能优化**:
   - 使用生成器读取大文件
   - 数据缓存机制
   - 异步处理
   - 进度条显示

3. **UI实现**:
   - 参考PyQt5官方文档
   - 使用Qt Designer设计界面
   - 分模块开发

4. **未实现功能**:
   - 保留按钮和UI元素
   - 添加占位函数
   - 添加TODO注释
   - 设计扩展接口

## 7. 质量保证

### 7.1 代码质量
- 遵循PEP 8编码规范
- 使用类型提示
- 完善的文档字符串
- 单元测试覆盖率 > 80%

### 7.2 功能完整性
- 所有MATLAB功能1:1实现
- 所有图表完全一致
- 所有计算结果验证

### 7.3 用户体验
- 界面友好
- 操作流畅
- 错误提示清晰
- 性能良好

## 8. 时间估算

- **总工期**: 18周（约4.5个月）
- **开发**: 14周
- **测试**: 2周
- **文档**: 2周

## 9. 里程碑

- **Week 2**: 基础架构完成
- **Week 4**: 数据解析完成
- **Week 6**: 计算模块完成
- **Week 9**: 绘图模块完成
- **Week 12**: GUI界面完成
- **Week 14**: 功能集成完成
- **Week 16**: 测试完成
- **Week 18**: 项目交付

## 10. 下一步行动

1. **立即开始**: 创建项目结构
2. **第一周**: 完成环境搭建和基础工具模块
3. **持续沟通**: 遇到问题及时讨论
4. **迭代开发**: 每个模块完成后进行验证

---

**注意**: 本计划为初步计划，在实际开发过程中可能需要根据实际情况进行调整。每个阶段完成后应进行评估，必要时调整后续计划。
