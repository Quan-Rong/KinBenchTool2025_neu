# 阶段四完成总结 - 绘图模块

**完成日期**: 2025-01-27  
**状态**: ✅ 核心绘图模块已完成

## 已完成工作

### 1. 绘图工具函数模块 (`src/plot/plot_utils.py`) ✅

#### 1.1 样式配置函数 ✅
- ✅ `setup_matplotlib_style()` - 设置matplotlib全局样式，使其与MATLAB风格一致
- ✅ `setup_axes_style()` - 设置坐标轴样式（标签、标题、网格、次刻度等）

#### 1.2 绘图函数 ✅
- ✅ `plot_data_curve()` - 绘制数据曲线
- ✅ `plot_fit_line()` - 绘制拟合直线（带标记点）

#### 1.3 文本标注函数 ✅
- ✅ `add_fit_formula_text()` - 添加拟合公式文本（y = ax + b）
- ✅ `add_direction_indicator()` - 添加方向指示文本（水平方向）
- ✅ `add_vertical_direction_indicator()` - 添加方向指示文本（垂直方向，旋转90度）
- ✅ `add_custom_text()` - 添加自定义文本

#### 1.4 其他工具函数 ✅
- ✅ `setup_legend()` - 设置图例
- ✅ `create_comparison_figure()` - 创建左右对比图表
- ✅ `clear_axes()` - 清空坐标轴
- ✅ `save_plot()` - 保存图表
- ✅ `convert_matlab_color_to_python()` - 将MATLAB颜色格式转换为Python格式

### 2. Bump测试绘图模块 (`src/plot/bump_plot.py`) ✅

#### 2.1 已实现的绘图函数 ✅
- ✅ `plot_bump_steer()` - Bump Steer图（左右对比）
- ✅ `plot_bump_camber()` - Bump Camber图（左右对比）
- ✅ `plot_wheel_rate()` - Wheel Rate图（左右对比）
- ✅ `plot_wheel_recession()` - Wheel Recession图（左右对比）
- ✅ `plot_track_change()` - Track Change图（左右对比）

#### 2.2 图表特性 ✅
- 左右轮对比显示
- 原始数据曲线
- 拟合直线（带标记点）
- 拟合公式显示
- 方向指示文本
- 统一的样式配置

### 3. Roll测试绘图模块 (`src/plot/roll_plot.py`) ✅

#### 3.1 已实现的绘图函数 ✅
- ✅ `plot_roll_steer()` - Roll Steer图（左右对比）
- ✅ `plot_roll_camber()` - Roll Camber图（左右对比）
- ✅ `plot_roll_camber_relative_ground()` - Roll Camber Relative Ground图（左右对比）
- ✅ `plot_roll_rate()` - Roll Rate图（悬架侧倾刚度和总侧倾刚度）
- ✅ `plot_roll_center_height()` - Roll Center Height图

#### 3.2 图表特性 ✅
- 左右轮对比显示（注意右轮数据取负处理）
- 原始数据曲线
- 拟合直线
- 拟合公式显示
- 统一的样式配置

### 4. Static Load测试绘图模块 (`src/plot/static_load_plot.py`) ✅

#### 4.1 Lateral测试绘图 ✅
- ✅ `plot_lateral_toe_compliance()` - Lateral Toe Compliance图（左右对比）
- ✅ `plot_lateral_camber_compliance()` - Lateral Camber Compliance图（左右对比）

#### 4.2 Braking测试绘图 ✅
- ✅ `plot_braking_toe_compliance()` - Braking Toe Compliance图（左右对比）

#### 4.3 Acceleration测试绘图 ✅
- ✅ `plot_acceleration_toe_compliance()` - Acceleration Toe Compliance图（左右对比）

#### 4.4 图表特性 ✅
- 左右轮对比显示
- 原始数据曲线
- 拟合直线
- 拟合公式显示
- 统一的样式配置

### 5. 模块集成 ✅
- ✅ 更新了`src/plot/__init__.py`，导出所有绘图函数
- ✅ 所有绘图函数都使用了统一的接口和样式配置

## 核心功能特点

### 1. 统一的样式配置
- 字体：Times New Roman
- 字体大小：10
- 线宽：1.5
- 网格：主网格和次网格
- 图例：自动定位在最佳位置

### 2. MATLAB兼容性
- 图表样式与MATLAB版本一致
- 颜色格式转换（支持MATLAB RGB数组）
- 文本位置和格式匹配MATLAB版本

### 3. 灵活的接口设计
- 所有绘图函数都接受可选的`curve_color`和`fit_color`参数
- 支持`compare_count`参数用于调整文本位置（多曲线对比）
- 统一的参数命名和返回格式

### 4. 数据处理
- 自动处理多维数据（左右轮、多维度参数）
- 自动进行单位转换（角度、长度、力）
- 自动查找零位置和拟合区间

## 绘图函数说明

### Bump测试绘图
1. **Bump Steer**: 绘制toe角随轮跳的变化曲线，显示拟合直线和公式
2. **Bump Camber**: 绘制camber角随轮跳的变化曲线，显示拟合直线和公式
3. **Wheel Rate**: 绘制车轮刚度随轮跳的变化曲线，显示拟合直线和斜率
4. **Wheel Recession**: 绘制轮心纵向位移随轮跳的变化曲线
5. **Track Change**: 绘制轮心横向位移随轮跳的变化曲线

### Roll测试绘图
1. **Roll Steer**: 绘制toe角随侧倾角的变化曲线（注意右轮数据取负）
2. **Roll Camber**: 绘制camber角随侧倾角的变化曲线（注意右轮数据取负）
3. **Roll Camber Relative Ground**: 绘制相对地面外倾角随侧倾角的变化曲线
4. **Roll Rate**: 绘制悬架侧倾刚度和总侧倾刚度随侧倾角的变化曲线
5. **Roll Center Height**: 绘制侧倾中心高度随侧倾角的变化曲线

### Static Load测试绘图
1. **Lateral Toe Compliance**: 绘制toe角随侧向力的变化曲线
2. **Lateral Camber Compliance**: 绘制camber角随侧向力的变化曲线
3. **Braking Toe Compliance**: 绘制toe角随制动力的变化曲线
4. **Acceleration Toe Compliance**: 绘制toe角随加速力的变化曲线

## 使用示例

```python
from src.data import ResParser, DataExtractor, KCCalculator
from src.plot import (
    plot_bump_steer, plot_roll_steer, plot_lateral_toe_compliance,
    create_comparison_figure, setup_matplotlib_style
)
import matplotlib.pyplot as plt

# 设置matplotlib样式
setup_matplotlib_style()

# 解析文件
parser = ResParser('path/to/file.res')
parser.parse()

# 创建计算器
extractor = DataExtractor(parser)
calculator = KCCalculator(extractor)

# 创建对比图表
fig, axes = create_comparison_figure(nrows=1, ncols=2)

# 绘制Bump Steer图
plot_bump_steer(axes[0], axes[1], calculator,
               fit_range=15,
               curve_color='#1f77b4',
               fit_color='#0000ff',
               compare_count=0)

plt.tight_layout()
plt.show()
```

## 注意事项

### 1. 数据格式假设
- 假设多维参数的第一列是左轮，第二列是右轮
- 某些参数（如wheel_load_longitudinal）有4列：brak_left, brak_right, driv_left, driv_right
- Roll测试中，右轮数据需要取负（与MATLAB版本一致）

### 2. 单位转换
- 角度：从弧度转换为度（在数据提取时完成）
- 长度：从米转换为毫米（在绘图时完成）
- 力：从N转换为kN（在绘图时完成）

### 3. 拟合区间
- Bump测试：默认拟合区间为±15mm
- Roll测试：默认拟合区间为±1.0度
- Static Load测试：默认拟合区间为±1.0kN

### 4. 颜色格式
- 支持MATLAB RGB数组格式（0-1之间）
- 支持颜色名称字符串
- 自动转换为matplotlib颜色格式

## 待完善功能

### 1. 更多Bump测试绘图
- [ ] Castor Angle图（主销后倾角随轮跳的变化）
- [ ] SVSA Angle图（侧视摆臂角随轮跳的变化）
- [ ] SVSA Length图（侧视摆臂长度随轮跳的变化）
- [ ] Wheel Load图（轮荷随轮跳的变化）

### 2. 更多Roll测试绘图
- [ ] Roll Steer @ WT图（基于轮跳的侧倾转向）
- [ ] Roll Camber @ WT图（基于轮跳的侧倾外倾）
- [ ] Tire Force图（轮胎力随侧倾角的变化）

### 3. 更多Static Load测试绘图
- [ ] Lateral Compliance图（侧向柔度）
- [ ] Lateral PC Compliance图（侧向力接触点柔度）
- [ ] Braking Camber Compliance图（制动力外倾柔度）
- [ ] Braking WC Compliance图（制动力轮心柔度）
- [ ] Braking PC Compliance图（制动力接触点柔度）
- [ ] Anti-dive图（抗点头率）
- [ ] Acceleration Camber Compliance图（加速力外倾柔度）
- [ ] Acceleration WC Compliance图（加速力轮心柔度）
- [ ] Anti-squat图（抗下蹲率）

### 4. 图表一致性验证
- [ ] 与MATLAB版本逐个图表对比
- [ ] 调整matplotlib参数以完全匹配MATLAB样式
- [ ] 确保字体、颜色、线型完全一致
- [ ] 确保坐标轴刻度完全一致
- [ ] 确保文本位置完全一致

## 代码质量

- ✅ 遵循PEP 8编码规范
- ✅ 使用类型提示
- ✅ 完善的文档字符串
- ✅ 模块化设计
- ✅ 统一的接口设计
- ✅ 无linter错误
- ⚠️ 需要添加单元测试

## 文件清单

### 新创建的文件
```
Python_Target/
└── src/
    └── plot/
        ├── __init__.py          # 模块导出
        ├── plot_utils.py        # 绘图工具函数（~400行）
        ├── bump_plot.py         # Bump测试绘图（~500行）
        ├── roll_plot.py          # Roll测试绘图（~400行）
        └── static_load_plot.py   # Static Load测试绘图（~400行）
```

### 更新的文件
```
Python_Target/
└── src/
    └── plot/
        └── __init__.py  # 添加了所有绘图函数的导出
```

## 总结

阶段四的绘图模块已经完成，包括：
- ✅ 所有主要测试工况的绘图函数
- ✅ 统一的样式配置和工具函数
- ✅ MATLAB兼容的图表样式
- ✅ 灵活的接口设计

**下一步重点**: 开始阶段五：GUI界面，实现PyQt6主窗口和各个Tab界面，集成绘图功能。
