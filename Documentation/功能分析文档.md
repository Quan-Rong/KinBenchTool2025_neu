# KnC_Bewertung MATLAB App 功能分析文档

## 1. 程序概述

**程序名称**: KnC_Bewertung_alpha20250127  
**程序类型**: MATLAB App Designer 应用程序  
**主要功能**: 处理Adams多体动力学仿真结果文件（.res格式），进行K&C（Kinematics & Compliance，运动学与柔顺性）分析  
**程序规模**: 主文件约10630行代码，包含大量UI组件和数据处理逻辑

## 2. 核心功能模块

### 2.1 文件读取与解析模块

#### 2.1.1 .res文件解析
- **功能**: 读取Adams仿真结果文件（.res格式）
- **处理流程**:
  1. 使用Perl脚本（countlines.pl）或Linux wc命令计算文件行数
  2. 逐行扫描文件，查找K&C参数定义
  3. 提取每个参数对应的ID号（通过正则表达式匹配）
  4. 解析quasiStatic数据段，提取所有分析步的数据

#### 2.1.2 K&C参数ID映射
程序识别并提取以下K&C参数的ID号：

**车轮角度参数**:
- `toe_angle`: 前束角 (left: 1796, right: 1797)
- `camber_angle`: 外倾角 (left: 1798, right: 1799)
- `caster_angle`: 主销后倾角 (left: 1760, right: 1761)
- `kingpin_incl_angle`: 主销内倾角 (left: 1762, right: 1763)

**几何参数**:
- `caster_moment_arm`: 主销后倾力臂 (left: 1790, right: 1791)
- `scrub_radius`: 磨胎半径 (left: 1788, right: 1789)
- `left_tire_contact_point`: 左轮接触点 (base: 1825, track: 1826)
- `right_tire_contact_point`: 右轮接触点 (base: 1830, track: 1831)
- `wheel_travel_track`: 轮心横向位移 (left: 1627, right: 1628)
- `wheel_travel_base`: 轮心纵向位移 (left: 1625, right: 1626)
- `total_track`: 总轮距 (vehicle: 1824)

**侧倾相关参数**:
- `roll_center_location`: 侧倾中心位置 (lateral: 1776, vertical: 1777)
- `roll_steer`: 侧倾转向 (left: 1774, right: 1775)
- `roll_camber_coefficient`: 侧倾外倾系数 (left: 1770, right: 1771)
- `susp_roll_rate`: 悬架侧倾刚度 (vehicle: 1784)
- `total_roll_rate`: 总侧倾刚度 (vehicle: 1785)

**载荷相关参数**:
- `wheel_load_lateral`: 侧向轮荷 (left: 1635, right: 1636)
- `wheel_load_longitudinal`: 纵向轮荷 (braking_left: 1631, braking_right: 1632, drive_left: 1633, drive_right: 1634)
- `wheel_load_align`: 回正力矩 (left: 1641, right: 1642)
- `wheel_load_vertical_force`: 垂向轮荷 (left: 1637, right: 1638)

**其他参数**:
- `anti_dive`: 抗点头率 (left: 1734, right: 1735)
- `anti_lift`: 抗抬头率 (left: 1742, right: 1743)
- `wheel_rate`: 车轮刚度 (left: 1780, right: 1781)
- `ride_rate`: 行驶刚度 (left: 1782, right: 1783)
- `left_tire_forces`: 左轮轮胎力 (x: 1867, y: 1868, z: 1869)
- `right_tire_forces`: 右轮轮胎力 (x: 1879, y: 1880, z: 1881)
- `side_view_swing_arm_angle`: 侧视摆臂角 (left: 1792, right: 1793)
- `side_view_swing_arm_length`: 侧视摆臂长度 (left: 1794, right: 1795)

### 2.2 测试工况处理模块

程序支持以下5种主要测试工况：

#### 2.2.1 Bump测试（Parallel Travel - 轮跳测试）
- **文件名标识**: `parallel_travel`
- **功能**: 分析车轮在垂直方向运动时的K&C特性
- **主要分析参数**:
  - Bump Steer（轮跳转向）: 左右轮toe角随轮跳的变化
  - Bump Camber（轮跳外倾）: 左右轮camber角随轮跳的变化
  - Wheel Rate（车轮刚度）: 轮荷随轮跳的变化
  - Wheel Recession（轮心后移）: 轮心纵向位移随轮跳的变化
  - Track Change（轮距变化）: 轮心横向位移随轮跳的变化
  - Castor Angle（主销后倾角）: 主销后倾角随轮跳的变化
  - Side View Swing Arm（侧视摆臂）: 摆臂角度和长度随轮跳的变化
- **计算指标**:
  - Bump Steer斜率 (deg/m)
  - Bump Camber斜率 (deg/m)
  - Wheel Rate (N/mm)
  - Wheel Recession (mm/m)
  - Track Change (mm/m)
  - 50mm轮跳时的toe角变化
  - 2g载荷时的轮跳行程和车轮刚度

#### 2.2.2 Roll测试（Opposite Travel - 侧倾测试）
- **文件名标识**: `opposite_travel` 或 `roll_angle`
- **功能**: 分析车辆侧倾时的K&C特性
- **主要分析参数**:
  - Roll Steer（侧倾转向）: toe角随侧倾角的变化
  - Roll Camber（侧倾外倾）: camber角随侧倾角的变化
  - Roll Camber Relative Ground（相对地面外倾）: 考虑车身侧倾后的外倾角
  - Suspension Roll Rate（悬架侧倾刚度）: 悬架侧倾刚度随侧倾角的变化
  - Total Roll Rate（总侧倾刚度）: 总侧倾刚度随侧倾角的变化
  - Roll Center Height（侧倾中心高度）: 侧倾中心高度随侧倾角的变化
  - Out-of-Phase Bump Steer/Camber（反相轮跳转向/外倾）: 左右轮反向运动时的特性
- **计算指标**:
  - Roll Steer系数 (deg/deg)
  - Roll Camber系数 (deg/deg)
  - Roll Camber Relative Ground系数
  - 悬架侧倾刚度 (Nm/deg)
  - 总侧倾刚度 (Nm/deg)
  - 侧倾中心高度 (mm)

#### 2.2.3 Static Load Lateral（侧向力测试）
- **文件名标识**: `static_load` 且包含侧向力数据
- **功能**: 分析在侧向力作用下的K&C特性
- **主要分析参数**:
  - Lateral Toe Compliance（侧向力前束柔度）: toe角随侧向力的变化
  - Lateral Camber Compliance（侧向力外倾柔度）: camber角随侧向力的变化
  - Lateral Compliance（侧向柔度）: 轮心横向位移随侧向力的变化
  - Lateral PC Compliance（侧向力接触点柔度）: 接触点位移随侧向力的变化
- **计算指标**:
  - Lateral Toe Compliance (deg/kN)
  - Lateral Camber Compliance (deg/kN)
  - Lateral Compliance (mm/kN)
  - Lateral PC Compliance (mm/kN)

#### 2.2.4 Static Load Braking（制动力测试）
- **文件名标识**: `static_load` 且包含制动力数据
- **功能**: 分析在制动力作用下的K&C特性
- **主要分析参数**:
  - Braking Toe Compliance（制动力前束柔度）: toe角随制动力的变化
  - Braking Camber Compliance（制动力外倾柔度）: camber角随制动力的变化
  - Braking WC Compliance（制动力轮心柔度）: 轮心位移随制动力的变化
  - Braking PC Compliance（制动力接触点柔度）: 接触点位移随制动力的变化
  - Anti-dive（抗点头率）: 抗点头率随制动力的变化
- **计算指标**:
  - Braking Toe Compliance (deg/kN)
  - Braking Camber Compliance (deg/kN)
  - Braking WC Compliance (mm/kN)
  - Braking PC Compliance (mm/kN)
  - Anti-dive (%)

#### 2.2.5 Static Load Acceleration（加速力测试）
- **文件名标识**: `static_load` 且包含加速力数据
- **功能**: 分析在加速力作用下的K&C特性
- **主要分析参数**:
  - Acceleration Toe Compliance（加速力前束柔度）
  - Acceleration Camber Compliance（加速力外倾柔度）
  - Acceleration WC Compliance（加速力轮心柔度）
  - Anti-squat（抗下蹲率）
- **计算指标**: 类似制动力测试

### 2.3 数据处理与计算模块

#### 2.3.1 数据提取
- 从quasiStatic_data矩阵中根据ID号提取所需参数
- 进行单位转换（弧度转角度，mm转m等）

#### 2.3.2 线性拟合
- 使用`polyfit`函数在指定区间内进行线性拟合
- 拟合区间可配置（通过EditField输入）
- 计算拟合直线的斜率和截距

#### 2.3.3 特征点定位
- 定位设计状态（0位置）
- 定位满载状态
- 定位特定载荷状态（如2g载荷）

### 2.4 绘图模块

#### 2.4.1 图表类型
每个测试工况包含多个子图表：
- 左右轮对比图（并排显示）
- 原始数据曲线
- 拟合直线
- 拟合区间标记

#### 2.4.2 图表特性
- **坐标轴**: 自定义标签、单位、刻度
- **图例**: 显示数据曲线和拟合曲线
- **文本标注**: 
  - 拟合公式（y = ax + b）
  - 方向指示（如"toe out << >> toe in"）
  - 计算得到的指标值
- **网格**: 主网格和次网格
- **颜色**: 可配置曲线颜色和拟合线颜色

### 2.5 UI界面模块

#### 2.5.1 主界面结构
- **顶部**: Logo、标题、版本信息
- **左侧**: 车辆参数输入面板
- **右侧**: K&C分析主界面（Tab组）

#### 2.5.2 车辆参数输入
- Half Load（半载质量）
- Max Load（满载质量）
- Unsprung Mass（非簧载质量）
- Wheel Base（轴距）
- Track Front/Rear（前后轮距）
- COG Height（重心高度）
- COG in x（重心X坐标）
- Roll Angle（侧倾角）
- Tire（轮胎规格）

#### 2.5.3 K&C分析界面
- **Tab组织**:
  - START/INFO: 启动信息和说明
  - Bump: 轮跳测试
  - Roll Test: 侧倾测试
  - Static Load Lateral: 侧向力测试
  - Static Load Braking: 制动力测试
  - Static Load Acceleration: 加速力测试
  - Align Torque: 回正力矩测试（未实现）

#### 2.5.4 每个测试Tab包含
- **文件选择**: 浏览按钮 + 文件路径显示 + GO执行按钮
- **参考车辆选择**: 多个StateButton用于选择参考车辆（未实现功能）
- **结果面板**: 显示计算得到的各项指标
- **图表Tab组**: 多个子Tab显示不同类型的图表
- **控制按钮**: 
  - Clear Axes（清空图表）
  - Positive Direction（正方向，未实现）
  - 自定义绘图按钮（未实现）
  - 导出PPT按钮（未实现）

#### 2.5.5 全局控制
- **颜色选择器**: 曲线颜色和拟合线颜色
- **对比数量**: Spinner控制可对比的曲线数量
- **保存按钮**: 
  - Save Results in EXCEL（未实现）
  - Save Results in PPT（未实现）
  - Add Results（未实现）
- **其他按钮**:
  - Reset（重置）
  - All KnC finished then output >>>>>> Chassis Synthesis Tool（未实现）

### 2.6 辅助功能模块

#### 2.6.1 文件行数统计
- Windows: 使用Perl脚本（countlines.pl）
- Linux: 使用wc命令

#### 2.6.2 单位转换
- 角度: 弧度 ↔ 度 (180/pi)
- 长度: mm ↔ m (1000)
- 刚度: mm/deg ↔ m/deg (pi/180/1000)

## 3. 数据流

### 3.1 输入
- Adams .res文件（包含quasiStatic分析结果）
- 车辆参数（通过UI输入）

### 3.2 处理
1. 读取.res文件
2. 解析参数ID
3. 提取数据矩阵
4. 根据工况类型选择处理逻辑
5. 进行数据计算和拟合
6. 更新UI显示

### 3.3 输出
- 图表显示（在UI中）
- 数值结果（在结果面板中）
- （计划）Excel导出
- （计划）PPT导出

## 4. 未实现功能

以下功能在UI中存在但未实现：
1. 参考车辆选择功能
2. Excel结果导出
3. PPT结果导出
4. 添加结果对比功能
5. 批量处理功能
6. 前悬架分析（Tab存在但为空）
7. 回正力矩测试（Tab存在但为空）
8. 自定义绘图功能
9. 正方向设置功能
10. 输出到Chassis Synthesis Tool功能

## 5. 程序特点

### 5.1 优点
- 功能全面，覆盖主要K&C测试工况
- UI界面完整，用户体验良好
- 数据处理逻辑清晰
- 图表展示详细

### 5.2 缺点
- 代码重复度高（各工况处理逻辑相似）
- 文件过大（10630行），维护困难
- 大量功能未实现但UI已存在
- 硬编码较多，可配置性差
- 缺乏错误处理机制
- 缺乏数据验证

## 6. 依赖文件

### 6.1 核心文件
- `KnC_Bewertung_alpha20250127.mlapp`: MATLAB App文件
- `KnC_Bewertung_alpha20250127_exported.m`: 导出的MATLAB代码（10630行）

### 6.2 绘图函数文件
- `KinBenchTool_Bump_Plot.m`: Bump测试绘图函数
- `KinBenchTool_Roll_Plot.m`: Roll测试绘图函数
- `KinBenchTool_StaticLoad_Plot.m`: 静态载荷测试绘图函数
- `KinBenchTool_braking_extra_plot.m`: 制动力测试额外绘图函数

### 6.3 辅助文件
- `countlines.pl`: Perl脚本，用于统计文件行数（Windows）
- 图像文件: Logo、图标等

### 6.4 数据文件
- `NRAC_G023_Results/`: 包含Adams仿真结果文件（.res格式）

## 7. 技术要点

### 7.1 文件解析
- 使用正则表达式匹配参数ID
- 逐行读取大文件
- 识别quasiStatic数据段

### 7.2 数据处理
- 矩阵索引提取数据
- 线性拟合（polyfit）
- 单位转换

### 7.3 UI设计
- MATLAB App Designer
- Tab组组织
- 动态图表更新

## 8. 重构建议

1. **模块化**: 将重复代码提取为函数
2. **配置化**: 将硬编码参数提取为配置文件
3. **错误处理**: 添加完善的错误处理机制
4. **数据验证**: 添加输入数据验证
5. **文档化**: 完善代码注释和文档
6. **测试**: 添加单元测试
7. **性能优化**: 优化大文件读取性能
