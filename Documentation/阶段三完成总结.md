# 阶段三完成总结 - K&C计算模块

**完成日期**: 2025-01-27  
**状态**: ✅ 核心计算模块已完成

## 已完成工作

### 1. K&C计算模块 (`src/data/kc_calculator.py`) ✅

#### 1.1 Bump测试计算函数 ✅
- ✅ `calculate_bump_steer()` - Bump Steer（轮跳转向）计算
- ✅ `calculate_bump_camber()` - Bump Camber（轮跳外倾）计算
- ✅ `calculate_wheel_rate()` - Wheel Rate（车轮刚度）计算
- ✅ `calculate_wheel_recession()` - Wheel Recession（轮心后移）计算
- ✅ `calculate_track_change()` - Track Change（轮距变化）计算
- ✅ `calculate_toe_at_50mm()` - 50mm轮跳时的toe角计算
- ✅ `calculate_2g_wheel_travel_and_rate()` - 2g载荷时的轮跳行程和车轮刚度计算

#### 1.2 Roll测试计算函数 ✅
- ✅ `calculate_roll_steer()` - Roll Steer（侧倾转向）计算
- ✅ `calculate_roll_camber()` - Roll Camber（侧倾外倾）计算
- ✅ `calculate_roll_camber_relative_ground()` - Roll Camber Relative Ground（相对地面外倾）计算
- ✅ `calculate_roll_rate()` - Roll Rate（侧倾刚度）计算
- ✅ `calculate_roll_center_height()` - Roll Center Height（侧倾中心高度）计算

#### 1.3 Static Load Lateral计算函数 ✅
- ✅ `calculate_lateral_toe_compliance()` - Lateral Toe Compliance（侧向力前束柔度）计算
- ✅ `calculate_lateral_camber_compliance()` - Lateral Camber Compliance（侧向力外倾柔度）计算

#### 1.4 Static Load Braking计算函数 ✅
- ✅ `calculate_braking_toe_compliance()` - Braking Toe Compliance（制动力前束柔度）计算
- ✅ `calculate_anti_dive()` - Anti-dive（抗点头率）计算

#### 1.5 Static Load Acceleration计算函数 ✅
- ✅ `calculate_acceleration_toe_compliance()` - Acceleration Toe Compliance（加速力前束柔度）计算
- ✅ `calculate_anti_squat()` - Anti-squat（抗下蹲率）计算

### 2. 模块集成 ✅
- ✅ 更新了`src/data/__init__.py`，添加了`KCCalculator`的导入
- ✅ 所有计算函数都使用了统一的接口和返回格式

## 核心功能特点

### 1. 统一的接口设计
- 所有计算函数都接受可选的`fit_range`和`zero_position_idx`参数
- 返回统一的字典格式，包含左右轮结果和平均值
- 包含拟合系数、零位置索引等详细信息

### 2. 数据处理
- 自动处理多维数据（左右轮、多维度参数）
- 自动进行单位转换（角度：弧度↔度，长度：米↔毫米）
- 自动查找零位置（如果未提供）

### 3. 线性拟合
- 使用`math_utils.linear_fit()`进行线性拟合
- 支持自定义拟合区间
- 返回拟合系数和拟合值

### 4. 特征点定位
- 使用`math_utils.find_zero_crossing()`查找零交叉点
- 使用`math_utils.find_value_index()`查找特定值的位置

## 计算函数说明

### Bump测试计算
1. **Bump Steer**: 计算toe角随轮跳的变化斜率（deg/m）
2. **Bump Camber**: 计算camber角随轮跳的变化斜率（deg/m）
3. **Wheel Rate**: 计算轮荷随轮跳的变化斜率（N/mm/mm）和零位置的Wheel Rate（N/mm）
4. **Wheel Recession**: 计算轮心纵向位移随轮跳的变化斜率（mm/m）
5. **Track Change**: 计算轮心横向位移随轮跳的变化斜率（mm/m）
6. **50mm轮跳toe角**: 提取50mm轮跳位置的toe角值
7. **2g载荷计算**: 计算2g载荷时的轮跳行程和车轮刚度

### Roll测试计算
1. **Roll Steer**: 计算toe角随侧倾角的变化系数（deg/deg）
2. **Roll Camber**: 计算camber角随侧倾角的变化系数（deg/deg）
3. **Roll Camber Relative Ground**: 计算相对地面外倾角随侧倾角的变化系数（deg/deg）
4. **Roll Rate**: 提取悬架侧倾刚度和总侧倾刚度（Nm/deg）
5. **Roll Center Height**: 提取侧倾中心高度（mm）

### Static Load Lateral计算
1. **Lateral Toe Compliance**: 计算toe角随侧向力的变化系数（deg/kN）
2. **Lateral Camber Compliance**: 计算camber角随侧向力的变化系数（deg/kN）

### Static Load Braking计算
1. **Braking Toe Compliance**: 计算toe角随制动力的变化系数（deg/kN）
2. **Anti-dive**: 提取抗点头率（%）

### Static Load Acceleration计算
1. **Acceleration Toe Compliance**: 计算toe角随加速力的变化系数（deg/kN）
2. **Anti-squat**: 提取抗下蹲率（%）

## 使用示例

```python
from src.data import ResParser, DataExtractor, KCCalculator

# 解析文件
parser = ResParser('path/to/file.res')
param_ids, quasi_static_data = parser.parse()

# 创建数据提取器
extractor = DataExtractor(parser)

# 创建K&C计算器
calculator = KCCalculator(extractor)

# 计算Bump Steer
bump_steer_result = calculator.calculate_bump_steer(fit_range=15)
print(f"Bump Steer: {bump_steer_result['average_slope']:.2f} deg/m")

# 计算Roll Steer
roll_steer_result = calculator.calculate_roll_steer(fit_range=1.0)
print(f"Roll Steer: {roll_steer_result['average_slope']:.3f} deg/deg")
```

## 注意事项

### 1. 数据格式假设
- 假设多维参数的第一列是左轮，第二列是右轮
- 某些参数（如wheel_load_longitudinal）有4列：brak_left, brak_right, driv_left, driv_right
- 需要根据实际数据格式调整索引

### 2. 单位转换
- 角度：从弧度转换为度（使用`convert_angle=True`）
- 长度：从米转换为毫米（使用`convert_length=True`）
- 力：从N转换为kN（在计算函数内部转换）

### 3. 拟合区间
- Bump测试：默认拟合区间为±15mm
- Roll测试：默认拟合区间为±1.0度
- Static Load测试：默认拟合区间为±1.0kN

### 4. 零位置查找
- 如果未提供`zero_position_idx`，会自动查找零交叉点
- 如果查找失败，使用数据中点作为零位置

## 待完善功能

### 1. 更多Static Load计算
- [ ] Lateral Compliance（侧向柔度）
- [ ] Lateral PC Compliance（侧向力接触点柔度）
- [ ] Braking Camber Compliance（制动力外倾柔度）
- [ ] Braking WC Compliance（制动力轮心柔度）
- [ ] Braking PC Compliance（制动力接触点柔度）
- [ ] Acceleration Camber Compliance（加速力外倾柔度）
- [ ] Acceleration WC Compliance（加速力轮心柔度）

### 2. 其他计算
- [ ] Castor Angle（主销后倾角）随轮跳的变化
- [ ] SVSA Angle/Length（侧视摆臂角度/长度）随轮跳的变化
- [ ] Roll Steer @ WT（基于轮跳的侧倾转向）
- [ ] Roll Camber @ WT（基于轮跳的侧倾外倾）

### 3. 数据验证
- [ ] 添加输入数据验证
- [ ] 添加边界条件检查
- [ ] 添加错误处理

## 代码质量

- ✅ 遵循PEP 8编码规范
- ✅ 使用类型提示
- ✅ 完善的文档字符串
- ✅ 模块化设计
- ✅ 统一的接口设计
- ⚠️ 需要添加单元测试

## 文件清单

### 新创建的文件
```
Python_Target/
└── src/
    └── data/
        └── kc_calculator.py  # K&C计算模块
```

### 更新的文件
```
Python_Target/
└── src/
    └── data/
        └── __init__.py  # 添加了KCCalculator导入
```

## 总结

阶段三的K&C计算模块已经完成，包括：
- ✅ 所有主要测试工况的计算函数
- ✅ 统一的接口和返回格式
- ✅ 自动数据处理和单位转换
- ✅ 线性拟合和特征点定位

**下一步重点**: 开始阶段四：绘图模块，实现各种K&C测试的图表绘制功能。
